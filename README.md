# Kirillov Client Simulator

Симулятор клиента для тестирования AI-агентов с интеграцией n8n webhook.

## Возможности

- **Разделенный интерфейс**: Чат для тестирования слева, редактор промпта справа
- **Системный промпт**: Настройка поведения AI-агента с счетчиком символов
- **Интеграция с n8n**: Все запросы отправляются на ваш webhook
- **Markdown поддержка**: Автоматическое форматирование ответов с поддержкой кода
- **Подсветка синтаксиса**: Highlight.js для красивого отображения кода
- **Копирование сообщений**: Кнопка для быстрого копирования любого сообщения
- **Экспорт диалога**: Сохранение беседы в JSON формате
- **Анимации**: Плавные переходы и анимированный индикатор печати
- **Временные метки**: Время отправки каждого сообщения
- **Автосохранение**: Автоматическое сохранение промпта в localStorage
- **История диалога**: Отправка контекста предыдущих сообщений
- **Горячие клавиши**: Enter для отправки, Shift+Enter для новой строки
- **Минималистичный дизайн**: Современный темный интерфейс

## Запуск

Просто откройте `index.html` в браузере. Никаких дополнительных зависимостей не требуется.

Или запустите локальный сервер:
```bash
npx http-server -p 3001
```

## Безопасный голосовой режим (без API key в браузере)

Чтобы сотрудники не вводили Gemini API key вручную:

1. Поднимите сервер выдачи ephemeral токенов из `server/gemini-token-server.mjs`.
2. Держите `GEMINI_API_KEY` только на сервере (env/secret manager).
3. Фронт по умолчанию дергает `POST /api/gemini-live-token` и отправляет Firebase ID token в `Authorization`.

Подробно: `server/README.md`.

### Быстрый сценарий для новичка (Render, 10-15 минут)

1. Зайдите в Render и создайте `New +` -> `Blueprint`.
2. Подключите этот GitHub-репозиторий.
3. Render сам увидит `render.yaml` и предложит сервис `client-simulator-gemini-token`.
4. Вставьте env:
`GEMINI_API_KEY`, `FIREBASE_WEB_API_KEY`, `FIREBASE_DATABASE_URL`, `ALLOWED_ORIGINS`, `ALLOWED_EMAIL_DOMAINS`, `GEMINI_LIVE_MODEL`.
5. Нажмите `Apply`.
6. Скопируйте URL сервиса, например `https://client-simulator-gemini-token.onrender.com`.
7. В приложении откройте настройки под админом и в `Gemini Voice -> Token endpoint` вставьте:
`https://client-simulator-gemini-token.onrender.com/api/gemini-live-token`, нажмите `Сохранить`.

После этого сотрудники могут использовать голосовой режим без ввода токена.

## Использование

1. **Настройте системный промпт** в правой панели (с отображением количества символов)
2. **Начните диалог** в левой панели - вводите сообщения и тестируйте агента
3. **Нажмите "Сохранить"** для явного сохранения промпта (автосохранение работает автоматически)
4. **Используйте "Очистить"** для начала нового диалога
5. **Экспортируйте диалог** через кнопку экспорта для сохранения беседы
6. **Копируйте сообщения** наведя на них курсор и нажав "Копировать"

### Горячие клавиши
- **Enter** - отправить сообщение
- **Shift + Enter** - новая строка в сообщении

## Формат запроса к webhook

```json
{
  "chatInput": "Сообщение пользователя из чата",
  "systemPrompt": "Системный промпт из правого окна",
  "history": [
    {
      "role": "user",
      "content": "Предыдущее сообщение"
    },
    {
      "role": "assistant",
      "content": "Предыдущий ответ"
    }
  ]
}
```

**Примечание:** Поле `chatInput` является обязательным для n8n Chat Trigger node.

## Формат ответа от webhook

Поддерживаются следующие форматы ответа:
- Простая строка
- `{ "response": "текст" }`
- `{ "message": "текст" }`
- `{ "output": "текст" }`
- `{ "text": "текст" }`

## Технологии

- HTML5
- CSS3 (Flexbox, Animations)
- Vanilla JavaScript (ES6+)
- n8n Webhook Integration
- Marked.js (Markdown rendering)
- Highlight.js (Syntax highlighting)

## Webhook URL

```
https://n8n-api.tradicia-k.ru/webhook/1f0629dc-22be-496b-bf2b-2d7090578a3c
```
